<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PUSLAT KODIKLATAU - Intelligence Database</title>
<style>
body { font-family: 'Courier New', monospace; background:black; color:#00FF00; margin:0; display:flex; flex-direction:column; height:100vh; }
header { background:black; color:#00FF00; padding:20px 0 10px 0; text-align:center; line-height:1.1; border-bottom:1px solid #00FF00; }
.text { font-size:75px; margin-bottom:0; }
.text1 { font-size:30px; margin-top:0; animation: blinkText 1s infinite; }
.header-buttons { display:flex; justify-content:center; gap:15px; margin-top:15px; }
.header-buttons button { background:transparent; border:1px solid #00FF00; color:#00FF00; padding:8px 15px; cursor:pointer; border-radius:4px; font-family:'Courier New', monospace; transition: background 0.3s, color 0.3s; }
.header-buttons button:hover { background-color:#00FF00; color:black; }
.main-container { display:flex; flex:1; border-top:1px solid #00FF00; }
.search-panel { width:35%; padding:20px; display:flex; flex-direction:column; border-right:2px solid #00FF00; }
.search-panel h2 { text-align:center; margin-bottom:20px; }
input { background:transparent; border:1px solid #00FF00; color:#00FF00; padding:10px; margin-bottom:15px; font-size:16px; border-radius:4px; outline:none; }
.info-text { font-size:14px; text-align:center; margin-top:10px; }
#member-buttons { display:flex; flex-direction:column; align-items:stretch; gap:10px; margin-top:10px; }
.output-panel { flex:1; padding:20px; overflow-y:auto; border-left:2px solid #00FF00; }
.agent-profile { display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap; }
.agent-profile pre { flex:1; white-space:pre-wrap; line-height:1.4; }
.agent-profile img { width:135px; height:185px; object-fit:cover; border:2px solid #00FF00; border-radius:8px; display:none; opacity:0; transition:opacity 0.6s ease-in-out; }
.doc-buttons { display:flex; gap:10px; margin-top:15px; }
.not-found { color:#FF0000; font-weight:bold; }
.agent-profile button,
#member-buttons button,
.doc-buttons button { background:transparent; border:1px solid #00FF00; color:#00FF00; padding:8px 12px; cursor:pointer; border-radius:4px; font-family:'Courier New', monospace; transition: background 0.3s, color 0.3s; }
.agent-profile button:hover,
#member-buttons button:hover,
.doc-buttons button:hover { background-color:#00FF00; color:black; }
@media (max-width:768px) {
    .main-container { flex-direction:column; }
    .search-panel, .output-panel { width:100%; border:none; border-bottom:1px solid #00FF00; }
    .agent-profile { flex-direction:column; align-items:center; }
}
.agent-profile pre::after { content:"_"; animation: blink 1s infinite; }
@keyframes blinkText { 0%,50%,100% { opacity:1; } 25%,75% { opacity:0; } }
</style>
</head>
<body>
<header>
    <h1 class="text">PUSLAT KODIKLATAU</h1>
    <h1 class="text1">DATABASE TERMINAL</h1>
    <div class="header-buttons">
        <button onclick="goTo('https://kodiklatau.tni-au.mil.id/struktur-organisasi')">STRUKTUR ORGANISASI</button>
        <button onclick="goTo('https://kodiklatau.tni-au.mil.id/radiogram')">RADIOGRAM</button>
        <button onclick="goTo('JAB KOSONG.html')">JAB KOSONG</button>
        <button onclick="goTo('KGB.html')">KGB</button>
        <button onclick="goTo('https://kodiklatau.tni-au.mil.id/orgas-puslat')">ORGAS PUSLAT</button>
    </div>
</header>

<div class="main-container">
    <div class="search-panel">
        <h2>üîç Data Lookup</h2>
        <label for="search">Masukkan Keyword Unit / Nama Lengkap:</label>
        <input type="text" id="search" placeholder="">
        <p class="info-text">Type the keyword then press ENTER to display the member list</p>
        <div id="member-buttons"></div>
    </div>

    <div class="output-panel" id="output">
        <div class="agent-profile" id="agent-container">
            <pre id="agent-dossier">
Biodata will appear after clicking the member button
            </pre>
            <img id="agent-photo" src="" alt="Foto Personel">
        </div>
    </div>
</div>

<script>
function goTo(url){ window.location.href = url; }

// Elements
const searchInput = document.getElementById("search");
const dossierEl = document.getElementById("agent-dossier");
const photoEl = document.getElementById("agent-photo");
const memberBtnContainer = document.getElementById("member-buttons");
const agentContainer = document.getElementById("agent-container");
const outputPanel = document.getElementById("output");

function getMonthsDiff(startDateStr){
    if(!startDateStr) return "-";
    const [day,month,year] = startDateStr.split("/").map(Number);
    const startDate = new Date(year, month-1, day);
    const now = new Date();
    let months = (now.getFullYear() - startDate.getFullYear())*12 + (now.getMonth() - startDate.getMonth());
    if(now.getDate()<startDate.getDate()) months--;
    return months>=0?months:0;
}

function typeWriter(element,text,agent,callback,speed=2){
    element.textContent="";
    let i=0, nameShown=false;
    function typing(){
        if(i<text.length){
            element.textContent += text.charAt(i);
            if(!nameShown && element.textContent.includes("NAMA LENGKAP")){
                nameShown=true;
                setTimeout(()=>{
                    photoEl.src = agent.photo_url || "";
                    photoEl.style.display="block";
                    setTimeout(()=> photoEl.style.opacity=1,100);
                },200);
            }
            i++;
            outputPanel.scrollTop = outputPanel.scrollHeight;
            setTimeout(typing,speed);
        } else if(callback) callback();
    }
    typing();
}

function simulateAccessSequence(element,callback){
    const steps = [
        ">>> initializing connection...",
        ">>> accessing database node...",
        ">>> verifying security clearance...",
        ">>> clearance level verified ‚úî",
        ">>> retrieving personnel data..."
    ];
    let i=0;
    element.textContent="";
    function nextStep(){
        if(i<steps.length){
            element.textContent += steps[i] + "\n";
            outputPanel.scrollTop = outputPanel.scrollHeight;
            i++;
            setTimeout(nextStep,600);
        } else setTimeout(callback,600);
    }
    nextStep();
}

function calculateAge(birthDateStr){
    if(!birthDateStr) return "-";
    const [day,month,year] = birthDateStr.split("-").map(Number);
    const today = new Date();
    let age = today.getFullYear() - year;
    if(today.getMonth()+1 < month || (today.getMonth()+1===month && today.getDate()<day)) age--;
    return age;
}

// ==== Fetch from Google Apps Script Web App ====
function showMemberButtons(keyword){
    memberBtnContainer.innerHTML='<span>Loading...</span>';

    fetch(`https://script.google.com/macros/s/AKfycbw9umh7Al0Zp5jCHaLF7w7de5Tj0EjwhHjAQ9tZf_2ofczxDc3ZufIpL1hB5ijffpPc/exec?keyword=${encodeURIComponent(keyword)}`)
    .then(response => response.json())
    .then(filtered => {
        memberBtnContainer.innerHTML="";
        if(filtered.length===0){
            memberBtnContainer.innerHTML='<span class="not-found">‚ùå No members found for this keyword</span>';
        } else {
            filtered.forEach(agent=>{
                const btn=document.createElement("button");
                btn.textContent=agent.nama_lengkap || "Unknown";
                btn.onclick=()=> displayAgent(agent);
                memberBtnContainer.appendChild(btn);
            });
        }
    })
    .catch(err => {
        console.error(err);
        memberBtnContainer.innerHTML='<span class="not-found">‚ùå Failed to fetch data</span>';
    });
}

function displayAgent(agent){
    photoEl.style.opacity=0;
    photoEl.style.display="none";
    simulateAccessSequence(dossierEl, ()=>{
        const dossierText = `
NAMA LENGKAP : ${agent.nama_lengkap || "-"}
PANGKAT       : ${agent.pangkat || "-"}
NIP           : ${agent.nip || "-"}
JABATAN       : ${agent.jabatan || "-"}
UNIT          : ${agent.unit || "-"}
TMT           : ${agent.tmt || "-"}
Masa Kerja    : ${getMonthsDiff(agent.tmt)} bulan
Tanggal Lahir : ${agent.tanggal_lahir || "-"} (Umur ${calculateAge(agent.tanggal_lahir)} th)
        `;
        typeWriter(dossierEl,dossierText,agent,()=>{
            const docContainer = document.createElement("div");
            docContainer.className="doc-buttons";
            if(agent.doc1) { const b=document.createElement("button"); b.textContent="Doc1"; b.onclick=()=> window.open(agent.doc1,"_blank"); docContainer.appendChild(b); }
            if(agent.doc2) { const b=document.createElement("button"); b.textContent="Doc2"; b.onclick=()=> window.open(agent.doc2,"_blank"); docContainer.appendChild(b); }
            if(agent.doc3) { const b=document.createElement("button"); b.textContent="Doc3"; b.onclick=()=> window.open(agent.doc3,"_blank"); docContainer.appendChild(b); }
            if(docContainer.childNodes.length>0){
                if(agentContainer.contains(agentContainer.querySelector(".doc-buttons"))) agentContainer.removeChild(agentContainer.querySelector(".doc-buttons"));
                agentContainer.appendChild(docContainer);
            }
        });
    });
}

searchInput.addEventListener("keypress", (e)=>{
    if(e.key==="Enter"){
        showMemberButtons(searchInput.value.trim());
    }
});
</script>
</body>
</html>
