<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personel Puslat Kodiklatau</title>
<style>
  body {
    font-family: monospace;
    background: #121212;
    color: #f0f0f0;
    margin: 0;
    padding: 0;
  }
  header {
    padding: 1rem;
    background: #1f1f1f;
    text-align: center;
    font-size: 1.2rem;
  }
  #search-container {
    display: flex;
    padding: 1rem;
    gap: 0.5rem;
    justify-content: center;
  }
  #search { padding: 0.5rem; width: 250px; font-size: 1rem; }
  #category-filter { padding: 0.5rem; font-size: 1rem; }
  #member-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    padding: 0.5rem;
    gap: 0.5rem;
  }
  #member-buttons button {
    padding: 0.5rem 1rem;
    background: #1f1f1f;
    border: 1px solid #555;
    color: #fff;
    cursor: pointer;
  }
  #member-buttons button:hover { background: #333; }
  #output {
    padding: 1rem;
    max-height: 500px;
    overflow-y: auto;
    border-top: 1px solid #555;
    background: #181818;
  }
  #agent-photo {
    display: block;
    margin: 1rem auto;
    max-width: 250px;
    border: 1px solid #555;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.5s ease-in-out;
  }
  .not-found { color: #ff4c4c; }
</style>
</head>
<body>
<header>
  PERSONEL PUSLAT KODIKLATAU – DATABASE
</header>

<div id="search-container">
  <input type="text" id="search" placeholder="Cari nama, satker, kategori..." />
  <select id="category-filter">
    <option value="">-- Filter Kategori --</option>
  </select>
</div>

<div id="member-buttons"></div>

<div id="output">
  <pre id="agent-dossier"></pre>
  <img id="agent-photo" src="" alt="Photo Personel">
</div>

<script>
// ======== GANTI DENGAN URL WEB APP APPS SCRIPT ========
const SPREADSHEET_JSON_URL = "https://script.google.com/macros/s/AKfycbwLCvnk7j7Wb5zXYG_J9m8aih1cj_2aW7vmGF3e0fzbYxTuRjow1tXeqjugFz7OB4wq/exec";

let personnelDB = [];

fetch(SPREADSHEET_JSON_URL)
  .then(res => res.json())
  .then(data => {
    personnelDB = data;
    console.log("✅ Data loaded", data);
    populateCategoryDropdown();
  })
  .catch(err => console.error("❌ Gagal memuat data:", err));

function populateCategoryDropdown() {
  const categorySelect = document.getElementById("category-filter");
  const uniqueCategories = [...new Set(personnelDB.map(p => p.kategori).filter(Boolean))];
  uniqueCategories.sort();
  uniqueCategories.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    categorySelect.appendChild(opt);
  });
}

function showMemberButtons(keyword){
  const memberBtnContainer = document.getElementById("member-buttons");
  memberBtnContainer.innerHTML = "";
  const selectedCategory = document.getElementById("category-filter").value;

  const filtered = personnelDB.filter(p => {
    const kw = keyword.toLowerCase();
    const matchKeyword = 
      (p.satker && p.satker.toLowerCase().includes(kw)) ||
      (p.nama_lengkap && p.nama_lengkap.toLowerCase().includes(kw)) ||
      (p.kategori && p.kategori.toLowerCase().includes(kw));
    const matchCategory = !selectedCategory || p.kategori === selectedCategory;
    return matchKeyword && matchCategory;
  });

  if(filtered.length === 0){
    memberBtnContainer.innerHTML = '<span class="not-found">❌ Tidak ditemukan</span>';
  } else {
    filtered.forEach(agent => {
      const btn = document.createElement("button");
      btn.textContent = agent.nama_lengkap;
      btn.onclick = () => displayAgent(agent);
      memberBtnContainer.appendChild(btn);
    });
  }
}

function displayAgent(agent){
  const dossierEl = document.getElementById("agent-dossier");
  const photoEl = document.getElementById("agent-photo");
  const outputPanel = document.getElementById("output");

  dossierEl.textContent = "";
  photoEl.style.display = "none";
  photoEl.src = "";

  function typeWriter(element, text, callback, speed=10){
    element.textContent = "";
    let i = 0;
    function typing() {
      if(i < text.length){
        element.textContent += text.charAt(i);
        i++;
        outputPanel.scrollTop = outputPanel.scrollHeight;
        setTimeout(typing, speed);
      } else if(callback) callback();
    }
    typing();
  }

  const dossier = `
========================================
|   FILE: PERSONEL PUSLAT KODIKLATAU   |
|   CLASSIFICATION: RAHASIA            |
========================================

[DATA IDENTITAS]
--------------------------------------------------
NAMA LENGKAP       : ${agent.nama_lengkap || "-"}
PANGKAT            : ${agent.pangkat || "-"}
NRP/NIP            : ${agent.nrp_nip || "-"}
JABATAN            : ${agent.jabatan || "-"}
SATKER             : ${agent.satker || "-"}
KORPS/SPESIALISASI : ${agent.korp_fung_spes || "-"}
TEMPAT/TGL LAHIR   : ${agent.tempat_lahir || "-"}, ${agent.tanggal_lahir || "-"}
AGAMA              : ${agent.agama || "-"}
USIA               : ${agent.tanggal_lahir ? calculateAge(agent.tanggal_lahir) : "-"}

[DATA KGB]
--------------------------------------------------
KGB TERAKHIR       : ${agent.kgb_terakhir || "-"}
TMT KGB            : ${agent.tmt_kgb || "-"}
KGB AKAN DATANG    : ${agent.tmt_kgb ? getNextKGB(agent.tmt_kgb) : "-"}

[DATA JABATAN]
--------------------------------------------------
NOMOR SKEP         : ${agent.nomer_skep || "-"}
TMT JABATAN        : ${agent.tmt_jabatan || "-"}
MASA JABATAN       : ${agent.tmt_jabatan ? getDetailedDiff(agent.tmt_jabatan) : "-"}

<END OF FILE>
========================================
Retrieved on: ${new Date().toLocaleString()}
  `;

  typeWriter(dossierEl, dossier, ()=>{
    if(agent.photo){
      photoEl.src = agent.photo;
      photoEl.style.display = "block";
      setTimeout(()=> photoEl.style.opacity = 1, 100);
    }
  });
}

function calculateAge(birthDateStr){
  const date = new Date(birthDateStr);
  const today = new Date();
  let age = today.getFullYear() - date.getFullYear();
  if(today.getMonth() < date.getMonth() || (today.getMonth()===date.getMonth() && today.getDate()<date.getDate())) age--;
  return age;
}

function getDetailedDiff(startDateStr){
  const startDate = new Date(startDateStr);
  const today = new Date();
  let years = today.getFullYear() - startDate.getFullYear();
  let months = today.getMonth() - startDate.getMonth();
  let days = today.getDate() - startDate.getDate();
  if(days < 0){ months--; days += new Date(today.getFullYear(), today.getMonth(), 0).getDate(); }
  if(months < 0){ years--; months+=12; }
  return `${years} Tahun ${months} Bulan ${days} Hari`;
}

function getNextKGB(tmtKGB){
  const tmt = new Date(tmtKGB);
  tmt.setFullYear(tmt.getFullYear() + 2);
  return getDetailedDiff(tmt);
}

const searchInput = document.getElementById("search");
searchInput.addEventListener("keydown", e=>{
  if(e.key==="Enter"){
    const query = searchInput.value.trim();
    if(query) showMemberButtons(query);
  }
});

document.getElementById("category-filter").addEventListener("change", ()=>{
  const query = searchInput.value.trim();
  showMemberButtons(query || "");
});
</script>
</body>
</html>
