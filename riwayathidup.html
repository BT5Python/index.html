<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PUSLAT KODIKLATAU - Intelligence Database</title>
<style>
body {
    font-family: 'Courier New', monospace;
    background: 
        linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)),
        url('BT5.jpg'); /* Gambar latar belakang */
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    color: #00FF00;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
}

header {
    background-color: black;
    padding: 20px 0 10px 0;
    text-align: center;
    line-height: 1.1;
    border-bottom: 1px solid #00FF00;
}

.text {
    font-size: 75px;
    margin-bottom: 0;
    color: #FFFF00; /* üî¥ hanya judul utama merah */
}

.text1 {
    font-size: 30px;
    margin-top: 0;
    color: #FF0000; /* bisa juga tetap merah untuk kontras */
    animation: blinkText 1s infinite;
}

.header-buttons button {
    background: transparent;
    border: 1px solid #00FF00;
    color: #00FF00; /* tombol tetap hijau */
    padding: 8px 15px;
    cursor: pointer;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    transition: background 0.3s, color 0.3s;
}
    .highlight-section {
    color: #FFFF00; /* kuning terang */
    font-weight: bold;
}


.header-buttons button:hover { background-color: #00FF00; color: black; }

.main-container { display: flex; flex: 1; border-top: 1px solid #00FF00; }
.search-panel {
    width: 35%; padding: 20px; display: flex; flex-direction: column;
    border-right: 2px solid #00FF00;
}
.search-panel h2 { text-align: center; margin-bottom: 20px; }
input, select {
    background: transparent; border: 1px solid #00FF00; color: #00FF00;
    padding: 10px; margin-bottom: 15px; font-size: 16px; border-radius: 4px; outline: none;
}
.info-text { font-size: 14px; text-align: center; margin-top: 10px; }
#member-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }

.output-panel { flex: 1; padding: 20px; overflow-y: auto; border-left: 2px solid #00FF00; }

.agent-profile { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
.agent-profile pre { flex: 1; white-space: pre-wrap; line-height: 1.4; }
.agent-profile img {
    width: 135px; height: 185px; object-fit: cover;
    border: 2px solid #00FF00; border-radius: 8px;
    display: none; opacity: 0; transition: opacity 1.2s ease-in-out;
}

.doc-buttons { display: flex; gap: 10px; margin-top: 15px; }
.not-found { color: #FF0000; font-weight: bold; }

button {
    background: transparent; border: 1px solid #00FF00; color: #00FF00;
    padding: 8px 12px; cursor: pointer; border-radius: 4px;
    font-family: 'Courier New', monospace; transition: background 0.3s, color 0.3s;
}
button:hover { background-color: #00FF00; color: black; }

@media (max-width: 768px) {
    .main-container { flex-direction: column; }
    .search-panel, .output-panel { width: 100%; border: none; border-bottom: 1px solid #00FF00; }
    .agent-profile { flex-direction: column; align-items: center; }
}
.agent-profile pre::after { content: "_"; animation: blink 1s infinite; }
@keyframes blinkText { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0; } }

/* Warna merah dan efek berkedip */
.secret-alert {
    color: #FF0000;
    font-weight: bold;
    animation: blinkSecret 1s infinite;
}

@keyframes blinkSecret {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0; }
}
    
</style>
</head>
<body>
<header>
    <h1 class="text">DATA RIWAYAT HIDUP PERSONEL</h1>
    <h1 class="text1">PORTAL MONITORING TERMINAL</h1>
    <div class="header-buttons">
        <button onclick="goTo('database.html')">BACK TO DATABASE</button>        
    </div>
</header>

<div class="main-container">
    <div class="search-panel">
        <h2>Puslat Kodiklatau</h2>
        <label for="category-filter">Filter By Category:</label>
        <select id="category-filter">
          <option value="">-- All Categories --</option>
        </select>

        <label for="search">Enter the Unit Keyword / Full Name</label>
        <input type="text" id="search" placeholder="">
        <p class="info-text">Select a category and type a keyword, then press ENTER to display a list of members</p>
        <div id="member-buttons"></div>
    </div>

    <div class="output-panel" id="output">
        <div class="agent-profile" id="agent-container">
            <pre id="agent-dossier">
Biodata will appear after clicking the member button
            </pre>
            <img id="agent-photo" src="" alt="Foto Personel">
        </div>
    </div>
</div>

<script>
function goTo(url) { window.location.href = url; }

// ======== LOAD DATABASE DARI GOOGLE SHEET ========
let personnelDB = [];

fetch("https://script.google.com/macros/s/AKfycbzRWVt8FF3kc_99AEtIZxhdF9L3J3aNbfdN31LN_9i58KEvtE2TDaod8eqffzmI6cO7ig/exec")
  .then(res => res.json())
  .then(data => {
    // ‚úÖ Bersihkan dan konversi link foto agar bisa langsung tampil
    personnelDB = data.map(person => {
      let photoURL = person.photo?.trim() || "";

      if (photoURL) {
        // Jika link Google Drive berformat /file/d/ID/view ‚Üí ubah ke format direct
        if (photoURL.includes("drive.google.com/file/d/")) {
          const match = photoURL.match(/\/d\/(.*?)\//);
          if (match && match[1]) {
            photoURL = `https://drive.google.com/uc?export=view&id=${match[1]}`;
          }
        }
        // Jika hanya ID (tanpa link)
        else if (/^[A-Za-z0-9_-]{25,}$/.test(photoURL)) {
          photoURL = `https://drive.google.com/uc?export=view&id=${photoURL}`;
        }
      } else {
        // Foto default
        photoURL = "https://drive.google.com/uc?export=view&id=13KgFyUzOSIUhfK8qw0skSLOEq5Yj0xp2";
      }

      return { ...person, photo: photoURL };
    });

    console.log("‚úÖ Data loaded & photo links normalized", personnelDB);
    populateCategoryDropdown();
  })
  .catch(err => console.error("‚ùå Gagal memuat data:", err));


function populateCategoryDropdown() {
  const categorySelect = document.getElementById("category-filter");
  const uniqueCategories = [...new Set(personnelDB.map(p => p.kategori).filter(Boolean))];
  uniqueCategories.sort();
  uniqueCategories.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    categorySelect.appendChild(opt);
  });
}

// ======== ELEMENTS ========
const searchInput = document.getElementById("search");
const dossierEl = document.getElementById("agent-dossier");
const photoEl = document.getElementById("agent-photo");
const memberBtnContainer = document.getElementById("member-buttons");
const agentContainer = document.getElementById("agent-container");
const outputPanel = document.getElementById("output");


// ======== FUNGSI FORMAT TANGGAL ========
function formatTanggalIndonesia(dateStr) {
    if (!dateStr) return "-";
    let date;
    try {
        date = new Date(dateStr);
        if (isNaN(date)) {
            const parts = dateStr.includes("/") ? dateStr.split("/") : dateStr.split("-");
            if (parts.length === 3) {
                const [d, m, y] = parts.map(Number);
                date = new Date(y, m - 1, d);
            } else return dateStr;
        }
    } catch {
        return dateStr;
    }
    const d = String(date.getDate()).padStart(2, "0");
    const m = String(date.getMonth() + 1).padStart(2, "0");
    const y = date.getFullYear();
    return `${d}/${m}/${y}`;
}


// ======== PERHITUNGAN SELISIH WAKTU ========
function getDetailedDiff(startDateStr) {
    if (!startDateStr) return "-";
    const startDate = new Date(startDateStr);
    if (isNaN(startDate)) return "-";

    const today = new Date();

    let years = startDate.getFullYear() - today.getFullYear();
    let months = startDate.getMonth() - today.getMonth();
    let days = startDate.getDate() - today.getDate();

    if (days < 0) {
        months--;
        const prevMonth = new Date(startDate.getFullYear(), startDate.getMonth(), 0);
        days += prevMonth.getDate();
    }
    if (months < 0) {
        years--;
        months += 12;
    }

    if (startDate < today) {
        return "Sudah lewat";
    }

    return `${years} Tahun ${months} Bulan ${days} Hari`;
}


// ======== HITUNG USIA ========
function calculateAge(birthDateStr) {
    if (!birthDateStr) return "-";
    const date = new Date(birthDateStr);
    if (isNaN(date)) return "-";

    const today = new Date();
    let age = today.getFullYear() - date.getFullYear();
    if (
        today.getMonth() < date.getMonth() ||
        (today.getMonth() === date.getMonth() && today.getDate() < date.getDate())
    ) {
        age--;
    }
    return age;
}

// ======== KGB BERIKUTNYA ========
function getNextKGB(tmtKGB) {
    if (!tmtKGB) return "-";
    const tmt = new Date(tmtKGB);
    if (isNaN(tmt)) return "-";

    // Hitung tanggal KGB berikutnya (2 tahun setelah TMT KGB)
    const nextKGB = new Date(tmt.getFullYear() + 2, tmt.getMonth(), tmt.getDate());

    // Format tanggal Indonesia
    const nextKGBformatted = formatTanggalIndonesia(nextKGB.toISOString());

    // Hitung selisih waktu dari hari ini ke tanggal KGB berikutnya
    const diffText = getDetailedDiff(nextKGB);

    // Gabungkan hasilnya
    return `${nextKGBformatted} (${diffText} lagi)`;
}


// ======== ANIMASI DAN TAMPILAN ========
// ... fungsi typeWriter, simulateAccessSequence, dll.

// ======== ANIMASI DAN TAMPILAN ========
function typeWriter(element, text, agent, callback, speed = 10) {
    element.innerHTML = ""; // gunakan innerHTML agar bisa sisipkan <span>
    let i = 0;
    let buffer = "";
    let nameShown = false;

    function typing() {
        if (i < text.length) {
            const char = text.charAt(i);
            buffer += char;

            // Render ulang isi teks dengan warna sesuai konteks
            element.innerHTML = buffer
                .split("\n")
                .map(line => {
                    // Warna kuning untuk bagian data
                    if (line.includes("[DATA IDENTITAS]") ||
                        line.includes("[DATA KGB]") ||
                        line.includes("[DATA JABATAN]")) {
                        return `<span class="highlight-section">${line}</span>`;
                    }
                    // Warna merah berkedip untuk tulisan RAHASIA
                    if (line.includes("RAHASIA")) {
                        return line.replace(
                            "RAHASIA",
                            `<span class="secret-alert">RAHASIA</span>`
                        );
                    }
                    return line;
                })
                .join("\n");

            // Tampilkan foto saat nama muncul
            if (!nameShown && element.textContent.includes("NAMA LENGKAP")) {
                nameShown = true;
                setTimeout(() => {
                    if (agent.photo) {
                        photoEl.src = agent.photo;
                        photoEl.style.display = "block";
                        setTimeout(() => (photoEl.style.opacity = 1), 100);
                    }
                }, 200);
            }

            i++;
            outputPanel.scrollTop = outputPanel.scrollHeight;
            setTimeout(typing, speed);
        } else if (callback) callback();
    }

    typing();
}



function simulateAccessSequence(element, callback){
    const steps = [
        ">>> initializing connection...",
        ">>> accessing database node...",
        ">>> verifying security clearance...",
        ">>> clearance level verified ‚úî",
        ">>> retrieving data riwayat hidup personel ‚úî"
    ];
    let i=0;
    element.textContent="";
    function nextStep(){
        if(i<steps.length){
            element.textContent += steps[i] + "\n";
            outputPanel.scrollTop = outputPanel.scrollHeight;
            i++;
            setTimeout(nextStep, 600);
        } else { setTimeout(callback, 600); }
    }
    nextStep();
}


// ======== FILTER DAN TAMPILKAN NAMA ANGGOTA ========
function showMemberButtons(keyword){
  memberBtnContainer.innerHTML = "";
  const selectedCategory = document.getElementById("category-filter") 
      ? document.getElementById("category-filter").value 
      : "";

  const filtered = personnelDB.filter(p => {
    const kw = keyword.toLowerCase();
    const matchKeyword = 
      (p.satker && p.satker.toLowerCase().includes(kw)) ||
      (p.nama_lengkap && p.nama_lengkap.toLowerCase().includes(kw)) ||
      (p.kategori && p.kategori.toLowerCase().includes(kw));
    const matchCategory = !selectedCategory || p.kategori === selectedCategory;
    return matchKeyword && matchCategory;
  });

  if(filtered.length === 0){
    memberBtnContainer.innerHTML = '<span class="not-found">‚ùå No members found for this filter</span>';
  } else {
    filtered.forEach(agent => {
      const btn = document.createElement("button");
      btn.textContent = agent.nama_lengkap;
      btn.onclick = () => displayAgent(agent);
      memberBtnContainer.appendChild(btn);
    });
  }
}
    
// ======== KGB BERIKUTNYA ========
function getNextKGB(tmtKGB) {
    if (!tmtKGB) return "-";
    const tmt = new Date(tmtKGB);
    if (isNaN(tmt)) return "-";

    // Asumsikan KGB setiap 2 tahun
    const nextKGB = new Date(tmt.getFullYear() + 2, tmt.getMonth(), tmt.getDate());
    return getDetailedDiff(nextKGB); // Selisih dari hari ini
}
    
// ======== HITUNG MASA JABATAN (DARI TMT SAMPAI HARI INI) ========
function getMasaKerja(tmtStr) {
    if (!tmtStr) return "-";
    const tmt = new Date(tmtStr);
    if (isNaN(tmt)) return "-";

    const today = new Date();

    let years = today.getFullYear() - tmt.getFullYear();
    let months = today.getMonth() - tmt.getMonth();
    let days = today.getDate() - tmt.getDate();

    if (days < 0) {
        months--;
        const prevMonth = new Date(today.getFullYear(), today.getMonth(), 0);
        days += prevMonth.getDate();
    }

    if (months < 0) {
        years--;
        months += 12;
    }

    return `${years} Tahun ${months} Bulan ${days} Hari`;
}


// ======== TAMPILKAN BIODATA DETAIL ========
// ======== TAMPILKAN BIODATA DETAIL ========
function displayAgent(agent) {
    // ======== FOTO PERSONEL ========
    if (agent.photo) {
        // Jika link dari Google Drive ‚Üí ubah ke format direct
        if (agent.photo.includes("drive.google.com/file/d/")) {
            const match = agent.photo.match(/\/d\/(.*?)\//);
            if (match && match[1]) {
                photoEl.src = `https://drive.google.com/uc?export=view&id=${match[1]}`;
            } else {
                photoEl.src = agent.photo; // fallback
            }
        } 
        // Jika hanya berupa ID Google Drive
        else if (/^[A-Za-z0-9_-]{25,}$/.test(agent.photo)) {
            photoEl.src = `https://drive.google.com/uc?export=view&id=${agent.photo}`;
        } 
        // Jika link sudah valid (misal imgur, url langsung)
        else {
            photoEl.src = agent.photo;
        }
    } else {
        // Gunakan foto default jika kosong
        photoEl.src = "https://drive.google.com/uc?export=view&id=13KgFyUzOSIUhfK8qw0skSLOEq5Yj0xp2";
    }

    photoEl.style.display = "block";
    photoEl.style.opacity = 1;

    // ======== HAPUS TOMBOL DOKUMEN SEBELUMNYA ========
    const oldDocs = agentContainer.querySelector(".doc-buttons");
    if (oldDocs) oldDocs.remove();

    // ======== SIMULASI LOADING SEBELUM BIODATA ========
    simulateAccessSequence(dossierEl, () => {
        const masaKerja = getMasaKerja(agent.tmt_jabatan);
        const masaKGB = getNextKGB(agent.tmt_kgb);
        const usia = calculateAge(agent.tanggal_lahir);

        // ======== TEMPLATE DATA PERSONEL ========
        const dossier = `
========================================
|   FILE: PERSONEL PUSLAT KODIKLATAU   |
|   CLASSIFICATION: RAHASIA            |
========================================

[DATA IDENTITAS]
--------------------------------------------------
NAMA LENGKAP        : ${agent.nama_lengkap || "-"}
PANGKAT             : ${agent.pangkat || "-"}
NRP/NIP             : ${agent.nrp_nip || "-"}
TEMPAT/TGL LAHIR    : ${agent.tempat_lahir || "-"}, ${formatTanggalIndonesia(agent.tanggal_lahir)}
GOL DARAH           : ${agent.gol_darah || "-"}
AGAMA               : ${agent.agama || "-"}
DIKUMTI             : ${agent.dikumti || "-"}
TMT DIKUMTI         : ${formatTanggalIndonesia(agent.tmt_dikumti)}
DIKMILTI            : ${agent.dikmilti || "-"}
TMT DIKMILTI        : ${formatTanggalIndonesia(agent.tmt_dikmilti)}
USIA                : ${usia} Tahun
NO TELEPON          : ${agent.no_telepon || "-"}

[DATA JABATAN]
--------------------------------------------------
JABATAN SAAT INI    : ${agent.jab_saat_ini || "-"}
TMT JABATAN         : ${formatTanggalIndonesia(agent.tmt_jabatan_saat_ini)}
JABATAN YG LALU     : ${agent.jabatan_yg_lalu || "-"}
TMT JABATAN         : ${formatTanggalIndonesia(agent.tmt_jabatan_yg_lalu)}

[TANDA JASA/KEHORMATAN]
--------------------------------------------------
1. ${agent.sd || "-"}, ${formatTanggalIndonesia(agent.tahun_keluar_sd)}
2. ${agent.smp || "-"}, ${formatTanggalIndonesia(agent.tahun_keluar_smp)}
3. ${agent.sma || "-"}, ${formatTanggalIndonesia(agent.tahun_keluar_sma)}

[SECURITY FOOTNOTE]
--------------------------------------------------
This dossier is property of PUSLAT KODIKLATAU.
Unauthorized access or duplication is punishable under applicable law.

<END OF FILE>
========================================
Retrieved on: ${new Date().toLocaleString()}
        `;

        // ======== EFEK KETIK TEKS ========
        typeWriter(dossierEl, dossier, agent, () => {
            // ======== TAMBAHKAN TOMBOL DOKUMEN ========
            const docContainer = document.createElement("div");
            docContainer.className = "doc-buttons";

            const docs = [
                { label: "KOSONG", url: "https://example.com/data-update" },
                { label: "Riwayat Hidup", url: "https://example.com/riwayat-hidup" },
                { label: "KOSONG", url: "https://example.com/ku-1" }
            ];

            docs.forEach(d => {
                const btn = document.createElement("button");
                btn.textContent = d.label;
                btn.onclick = () => window.open(d.url, "_blank");
                docContainer.appendChild(btn);
            });

            agentContainer.appendChild(docContainer);
        });
    });
}


// ======== EVENT SEARCH ========
searchInput.addEventListener("input", ()=>{
    dossierEl.textContent="Biodata will appear after clicking the member button";
    const oldDocs = agentContainer.querySelector(".doc-buttons");
    if(oldDocs) oldDocs.remove();
    memberBtnContainer.innerHTML="";
});
searchInput.addEventListener("keydown", e=>{
    if(e.key==="Enter"){
        const query = searchInput.value.trim();
        if(query) showMemberButtons(query);
    }
});
</script>
// ======== evolutionismyrevolution/BT5Python ========
</body>
</html>

























