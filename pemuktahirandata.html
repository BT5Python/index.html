/***************************************
 * PUSLAT KODIKLATAU - MERGE & DATA API
 * -------------------------------------
 * Fungsi:
 * 1. mergeDocumentData() ‚Üí Membuat file PDF merge per baris data
 * 2. doGet() ‚Üí Menyediakan JSON untuk Web App
 ***************************************/

// ‚úÖ 1Ô∏è‚É£ Buat dokumen merge dari template Google Docs
function mergeDocumentData() {
  const ss = SpreadsheetApp.openById("1Vh82puHKiyKe0KexQSjRdEZDpuHiUBiVaN31mxbuxZY"); // ID Spreadsheet
  const sheet = ss.getSheetByName("DATA");
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();

  // Kolom yang digunakan
  const namaCol = headers.indexOf("nama_lengkap") + 1;
  const mergedUrlCol = headers.indexOf("Merged Doc URL - PEMUKTAHIRAN DATA") + 1;
  const linkCol = headers.indexOf("Link to merged Doc - PEMUKTAHIRAN DATA") + 1;
  const statusCol = headers.indexOf("Document Merge Status - PEMUKTAHIRAN DATA") + 1;

  // Ganti dengan ID template Google Docs kamu
  const templateId = "1aBCdEfgHiJKlmNOPqRsTUvwXYZxxxxx"; 

  // Folder tujuan PDF (opsional)
  // const folder = DriveApp.getFolderById("1xxxxxxxYOUR_FOLDER_IDxxxxxx");

  for (let i = 0; i < data.length; i++) {
    const row = data[i];
    const namaLengkap = row[namaCol - 1];
    if (!namaLengkap) continue;

    try {
      // 1Ô∏è‚É£ Duplikasi template
      const templateFile = DriveApp.getFileById(templateId);
      const newFile = templateFile.makeCopy(`PEMUKTAHIRAN DATA - ${namaLengkap}`);
      const doc = DocumentApp.openById(newFile.getId());
      const body = doc.getBody();

      // 2Ô∏è‚É£ Ganti placeholder dengan data Sheet
      headers.forEach((header, j) => {
        const placeholder = `<<${header}>>`;
        body.replaceText(placeholder, row[j] || "");
      });
      doc.saveAndClose();

      // 3Ô∏è‚É£ Konversi ke PDF
      const pdfBlob = DriveApp.getFileById(newFile.getId()).getAs("application/pdf");
      const pdfFile = DriveApp.createFile(pdfBlob).setName(`PEMUKTAHIRAN DATA - ${namaLengkap}.pdf`);
      // const pdfFile = folder.createFile(pdfBlob).setName(`PEMUKTAHIRAN DATA - ${namaLengkap}.pdf`); // kalau pakai folder

      // 4Ô∏è‚É£ Ambil link PDF
      const pdfUrl = pdfFile.getUrl();

      // 5Ô∏è‚É£ Tulis hasil ke Sheet
      const sheetRow = i + 2; // (header dihapus dengan shift)
      sheet.getRange(sheetRow, mergedUrlCol).setValue(pdfUrl);
      sheet.getRange(sheetRow, linkCol).setValue(`=HYPERLINK("${pdfUrl}", "PEMUKTAHIRAN DATA - ${namaLengkap}")`);
      sheet.getRange(sheetRow, statusCol).setValue("Document successful");

      // 6Ô∏è‚É£ Hapus file DOCX (optional)
      DriveApp.getFileById(newFile.getId()).setTrashed(true);

    } catch (err) {
      const sheetRow = i + 2;
      sheet.getRange(sheetRow, statusCol).setValue(`Error: ${err.message}`);
      Logger.log(err);
    }
  }
}

// ‚úÖ 2Ô∏è‚É£ Fungsi untuk memberikan data JSON ke web (HTML)
function doGet() {
  const ss = SpreadsheetApp.openById("1Vh82puHKiyKe0KexQSjRdEZDpuHiUBiVaN31mxbuxZY"); 
  const sheet = ss.getSheetByName("DATA");

  const range = sheet.getDataRange();
  const values = range.getValues();
  const formulas = range.getFormulas(); // üîπ untuk deteksi hyperlink formula
  const headers = values.shift();
  formulas.shift();

  const json = values.map((row, rIdx) => {
    const obj = {};
    headers.forEach((h, cIdx) => {
      let val = row[cIdx];

      // üîç Kalau sel berisi rumus =HYPERLINK, ambil URL-nya dari formula
      const f = formulas[rIdx][cIdx];
      if (f && f.startsWith('=HYPERLINK(')) {
        const match = f.match(/"([^"]+)"/);
        if (match && match[1]) val = match[1];
      }

      obj[h] = val;
    });
    return obj;
  });

  return ContentService
    .createTextOutput(JSON.stringify(json))
    .setMimeType(ContentService.MimeType.JSON);
}
