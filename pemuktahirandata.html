<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PUSLAT KODIKLATAU - Intelligence Database</title>
<style>
body {
    font-family: 'Courier New', monospace;
    background: 
        linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.85)),
        url('BT5.jpg');
    background-size: cover;
    background-position: center;
    background-attachment: fixed;
    color: #00FF00;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
}

header {
    background-color: black;
    padding: 20px 0 10px 0;
    text-align: center;
    line-height: 1.1;
    border-bottom: 1px solid #00FF00;
}

.text {
    font-size: 75px;
    margin-bottom: 0;
    color: #FFFF00;
}

.text1 {
    font-size: 30px;
    margin-top: 0;
    color: #FF0000;
    animation: blinkText 1s infinite;
}

.header-buttons button {
    background: transparent;
    border: 1px solid #00FF00;
    color: #00FF00;
    padding: 8px 15px;
    cursor: pointer;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    transition: background 0.3s, color 0.3s;
}

.header-buttons button:hover { background-color: #00FF00; color: black; }

.highlight-section { color: #FFFF00; font-weight: bold; }

.main-container { display: flex; flex: 1; border-top: 1px solid #00FF00; }
.search-panel {
    width: 35%; padding: 20px; display: flex; flex-direction: column;
    border-right: 2px solid #00FF00;
}
.search-panel h2 { text-align: center; margin-bottom: 20px; }

input, select {
    background: transparent; border: 1px solid #00FF00; color: #00FF00;
    padding: 10px; margin-bottom: 15px; font-size: 16px; border-radius: 4px; outline: none;
}
.info-text { font-size: 14px; text-align: center; margin-top: 10px; }

#member-buttons { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }

.output-panel { flex: 1; padding: 20px; overflow-y: auto; border-left: 2px solid #00FF00; }

.agent-profile { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
.agent-profile pre { flex: 1; white-space: pre-wrap; line-height: 1.4; }
.agent-profile img {
    width: 135px; height: 185px; object-fit: cover;
    border: 2px solid #00FF00; border-radius: 8px;
    display: none; opacity: 0; transition: opacity 1.5s ease-in-out;
}

.doc-buttons { display: flex; gap: 10px; margin-top: 15px; }
.not-found { color: #FF0000; font-weight: bold; }

button {
    background: transparent; border: 1px solid #00FF00; color: #00FF00;
    padding: 8px 12px; cursor: pointer; border-radius: 4px;
    font-family: 'Courier New', monospace; transition: background 0.3s, color 0.3s;
}
button:hover { background-color: #00FF00; color: black; }

@media (max-width: 768px) {
    .main-container { flex-direction: column; }
    .search-panel, .output-panel { width: 100%; border: none; border-bottom: 1px solid #00FF00; }
    .agent-profile { flex-direction: column; align-items: center; }
}

.agent-profile pre::after { content: "_"; animation: blink 1s infinite; }
@keyframes blinkText { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0; } }

.secret-alert {
    color: #FF0000;
    font-weight: bold;
    animation: blinkSecret 1s infinite;
}
@keyframes blinkSecret { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0; } }

/* Loading indikator */
#loading {
    text-align: center;
    color: #FFFF00;
    font-weight: bold;
    margin-top: 20px;
    display: none;
}
</style>
</head>
<body>
<header>
    <h1 class="text">PEMUKTAHIRAN DATA PERSONEL</h1>
    <h1 class="text1">PORTAL MONITORING TERMINAL</h1>
    <div class="header-buttons">
        <button onclick="goTo('https://kodiklatau.tni-au.mil.id/struktur-organisasi')">HOME</button>
        <button onclick="goTo('https://drive.google.com/file/d/1yVTqVRGcSVl23pub1H9uzOmB3psxDpNE/view?usp=drive_link')">JAB. KOSONG</button>
        <button onclick="goTo('https://drive.google.com/file/d/1C2pZkcf6TwuQ4O5AJrzXM15v99e66rfo/view?usp=drive_link')">STRUKTUR ORGANISASI</button>
        <button onclick="window.location.href='kgbnew.html'">KGB</button>
        <button onclick="goTo('https://kodiklatau.tni-au.mil.id/orgas-puslat')">RADIOGRAM</button>
        <button onclick="goTo('https://kodiklatau.tni-au.mil.id/orgas-puslat')">BACK</button>
        <button onclick="goTo('https://kodiklatau.tni-au.mil.id/orgas-puslat')">NEXT</button>
    </div>
</header>

<div class="main-container">
    <div class="search-panel">
        <h2>Puslat Kodiklatau</h2>
        <label for="category-filter">Filter By Category:</label>
        <select id="category-filter">
          <option value="">-- All Categories --</option>
        </select>

        <label for="search">Enter the Unit Keyword / Full Name</label>
        <input type="text" id="search" placeholder="">
        <p class="info-text">Select a category and type a keyword, then press ENTER</p>
        <div id="member-buttons"></div>
        <div id="loading">⏳ Loading data from server...</div>
    </div>

    <div class="output-panel" id="output">
        <div class="agent-profile" id="agent-container">
            <pre id="agent-dossier">Biodata will appear after clicking the member button</pre>
            <img id="agent-photo" src="" alt="Foto Personel">
        </div>
    </div>
</div>

<script>
function goTo(url){ window.location.href = url; }

// ================== LOAD DATABASE DARI GOOGLE SHEET ==================
let personnelDB = [];

const loadingIndicator = document.getElementById("loading");
loadingIndicator.style.display = "block"; // tampilkan saat awal

fetch("https://script.google.com/macros/s/AKfycbyeW1HMOPvScfIBlVSjozy9NCZegIir741jH_P8F3qIrs0-MIW99sv1B-YAxvrgHhwtww/exec")
  .then(res => res.json())
  .then(data => {
    personnelDB = data.map(person => {
      let photoURL = person.photo?.trim() || "";
      if (photoURL) {
        if (photoURL.includes("drive.google.com/file/d/")) {
          const match = photoURL.match(/\/d\/(.*?)\//);
          if (match && match[1]) photoURL = `https://drive.google.com/uc?export=view&id=${match[1]}`;
        } else if (/^[A-Za-z0-9_-]{25,}$/.test(photoURL)) {
          photoURL = `https://drive.google.com/uc?export=view&id=${photoURL}`;
        }
      } else {
        photoURL = "https://drive.google.com/uc?export=view&id=13KgFyUzOSIUhfK8qw0skSLOEq5Yj0xp2";
      }
      return { ...person, photo: photoURL };
    });
    console.log("✅ Data loaded & photo links normalized", personnelDB);
    populateCategoryDropdown();
  })
  .catch(err => {
    console.error("❌ Gagal memuat data:", err);
    alert("Gagal memuat data dari server!");
  })
  .finally(() => loadingIndicator.style.display = "none");

// ================== FUNGSI TAMBAHAN ==================
function populateCategoryDropdown() {
  const categorySelect = document.getElementById("category-filter");
  const uniqueCategories = [...new Set(personnelDB.map(p => p.kategori).filter(Boolean))];
  uniqueCategories.sort();
  uniqueCategories.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    categorySelect.appendChild(opt);
  });
}

function formatTanggalIndonesia(dateStr) {
  if (!dateStr) return "-";
  const date = new Date(dateStr);
  if (isNaN(date)) return dateStr;
  const d = String(date.getDate()).padStart(2, "0");
  const m = String(date.getMonth() + 1).padStart(2, "0");
  const y = date.getFullYear();
  return `${d}/${m}/${y}`;
}

function getDetailedDiff(targetDate) {
  if (!targetDate) return "-";
  const date = new Date(targetDate);
  if (isNaN(date)) return "-";
  const now = new Date();
  if (date < now) return "Sudah lewat";
  const diff = date - now;
  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const years = Math.floor(days / 365);
  const months = Math.floor((days % 365) / 30);
  const dayRemainder = days - years * 365 - months * 30;
  return `${years} Tahun ${months} Bulan ${dayRemainder} Hari`;
}

function calculateAge(birthDateStr) {
  if (!birthDateStr) return "-";
  const birth = new Date(birthDateStr);
  if (isNaN(birth)) return "-";
  const now = new Date();
  let age = now.getFullYear() - birth.getFullYear();
  if (now.getMonth() < birth.getMonth() || (now.getMonth() === birth.getMonth() && now.getDate() < birth.getDate())) {
    age--;
  }
  return age;
}

function getNextKGB(tmtKGB) {
  if (!tmtKGB) return "-";
  const tmt = new Date(tmtKGB);
  if (isNaN(tmt)) return "-";
  const nextKGB = new Date(tmt.getFullYear() + 2, tmt.getMonth(), tmt.getDate());
  return `${formatTanggalIndonesia(nextKGB)} (${getDetailedDiff(nextKGB)} lagi)`;
}

function getMasaKerja(tmtStr) {
  if (!tmtStr) return "-";
  const tmt = new Date(tmtStr);
  if (isNaN(tmt)) return "-";
  const today = new Date();
  let years = today.getFullYear() - tmt.getFullYear();
  let months = today.getMonth() - tmt.getMonth();
  let days = today.getDate() - tmt.getDate();
  if (days < 0) { months--; days += 30; }
  if (months < 0) { years--; months += 12; }
  return `${years} Tahun ${months} Bulan ${days} Hari`;
}

function simulateAccessSequence(element, callback) {
  const steps = [
    ">>> initializing connection...",
    ">>> accessing database node...",
    ">>> verifying security clearance...",
    ">>> clearance level verified ✔",
    ">>> retrieving personnel data..."
  ];
  let i = 0;
  element.textContent = "";
  function next() {
    if (i < steps.length) {
      element.textContent += steps[i] + "\n";
      i++;
      setTimeout(next, 600);
    } else callback();
  }
  next();
}

function typeWriter(element, text, agent, callback, speed = 10) {
  element.innerHTML = "";
  let i = 0;
  let buffer = "";
  function typing() {
    if (i < text.length) {
      buffer += text.charAt(i);
      element.innerHTML = buffer
        .split("\n")
        .map(line => {
          if (line.includes("[DATA IDENTITAS]") || line.includes("[DATA KGB]") || line.includes("[DATA JABATAN]"))
            return `<span class="highlight-section">${line}</span>`;
          if (line.includes("RAHASIA"))
            return line.replace("RAHASIA", `<span class="secret-alert">RAHASIA</span>`);
          return line;
        })
        .join("\n");
      i++;
      setTimeout(typing, speed);
    } else if (callback) callback();
  }
  typing();
}

// ================== FIX FOTO GOOGLE DRIVE + TAMPILAN ==================
function displayAgent(agent) {
  // Foto personel
  if (agent.photo) {
    photoEl.src = agent.photo;
  } else {
    photoEl.src = "https://drive.google.com/uc?export=view&id=13KgFyUzOSIUhfK8qw0skSLOEq5Yj0xp2";
  }
  photoEl.style.display = "block";
  photoEl.style.opacity = 0;
  setTimeout(() => (photoEl.style.opacity = 1), 200);

  const oldDocs = agentContainer.querySelector(".doc-buttons");
  if (oldDocs) oldDocs.remove();

  simulateAccessSequence(dossierEl, () => {
    const masaKerja = getMasaKerja(agent.tmt_jabatan);
    const masaKGB = getNextKGB(agent.tmt_kgb);
    const usia = calculateAge(agent.tanggal_lahir);

    const dossier = `
========================================
|   FILE: PERSONEL PUSLAT KODIKLATAU   |
|   CLASSIFICATION: RAHASIA            |
========================================

[DATA IDENTITAS]
--------------------------------------------------
NAMA LENGKAP       : ${agent.nama_lengkap || "-"}
PANGKAT            : ${agent.pangkat || "-"}
NRP/NIP            : ${agent.nrp_nip || "-"}
JABATAN            : ${agent.jabatan || "-"}
SATKER             : ${agent.satker || "-"}
KORPS/SPESIALISASI : ${agent.korp_fung_spes || "-"}
TEMPAT/TGL LAHIR   : ${agent.tempat_lahir || "-"}, ${formatTanggalIndonesia(agent.tanggal_lahir)}
AGAMA              : ${agent.agama || "-"}
USIA               : ${usia} Tahun

[DATA KGB]
--------------------------------------------------
KGB TERAKHIR       : ${agent.kgb_terakhir || "-"}
TMT KGB            : ${formatTanggalIndonesia(agent.tmt_kgb)}
KGB AKAN DATANG    : ${masaKGB}

[DATA JABATAN]
--------------------------------------------------
NOMOR SKEP         : ${agent.nomer_skep || "-"}
TMT JABATAN        : ${formatTanggalIndonesia(agent.tmt_jabatan)}
MASA JABATAN       : ${masaKerja}

[SECURITY FOOTNOTE]
--------------------------------------------------
This dossier is property of PUSLAT KODIKLATAU.
Unauthorized access or duplication is punishable under applicable law.

<END OF FILE>
========================================
Retrieved on: ${new Date().toLocaleString()}
    `;

    typeWriter(dossierEl, dossier, agent, () => {
      const docContainer = document.createElement("div");
      docContainer.className = "doc-buttons";
      const docs = [
        { label: "Pemuktahiran Data", url: "#" },
        { label: "Riwayat Hidup", url: "#" },
        { label: "KU-1", url: "#" }
      ];
      docs.forEach(d => {
        const btn = document.createElement("button");
        btn.textContent = d.label;
        btn.onclick = () => window.open(d.url, "_blank");
        docContainer.appendChild(btn);
      });
      agentContainer.appendChild(docContainer);
    });
  });
}

// ================== FILTER ==================
const searchInput = document.getElementById("search");
const dossierEl = document.getElementById("agent-dossier");
const photoEl = document.getElementById("agent-photo");
const memberBtnContainer = document.getElementById("member-buttons");
const agentContainer = document.getElementById("agent-container");

function showMemberButtons(keyword) {
  memberBtnContainer.innerHTML = "";
  const cat = document.getElementById("category-filter").value;
  const filtered = personnelDB.filter(p => {
    const kw = keyword.toLowerCase();
    const match = (p.satker?.toLowerCase().includes(kw) || p.nama_lengkap?.toLowerCase().includes(kw) || p.kategori?.toLowerCase().includes(kw));
    return (!cat || p.kategori === cat) && match;
  });
  if (filtered.length === 0) {
    memberBtnContainer.innerHTML = '<span class="not-found">❌ No members found</span>';
  } else {
    filtered.forEach(agent => {
      const btn = document.createElement("button");
      btn.textContent = agent.nama_lengkap;
      btn.onclick = () => displayAgent(agent);
      memberBtnContainer.appendChild(btn);
    });
  }
}

searchInput.addEventListener("keypress", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    showMemberButtons(searchInput.value.trim());
  }
});
</script>
</body>
</html>
