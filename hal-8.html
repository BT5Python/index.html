from flask import Flask, render_template_string, request, redirect, url_for
import pyotp
import qrcode
import io
import base64

app = Flask(__name__)

# Simulasi user database
users = {
    "user1": {
        "password": "password123",  # password biasa
        "secret": pyotp.random_base32()  # secret Google Authenticator
    }
}

# Halaman login
login_page = """
<h2>Login</h2>
<form method="post">
    Username: <input type="text" name="username"><br>
    Password: <input type="password" name="password"><br>
    <input type="submit" value="Login">
</form>
"""

# Halaman OTP
otp_page = """
<h2>Masukkan OTP Google Authenticator</h2>
<form method="post">
    OTP: <input type="text" name="otp"><br>
    <input type="submit" value="Verify">
</form>
"""

@app.route('/', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        user = users.get(username)
        if user and user['password'] == password:
            # simpan username sementara di session sederhana
            return redirect(url_for('verify_otp', username=username))
        else:
            return "Login gagal!"
    return render_template_string(login_page)

@app.route('/verify/<username>', methods=['GET', 'POST'])
def verify_otp(username):
    user = users.get(username)
    if not user:
        return "User tidak ditemukan"

    if request.method == 'POST':
        otp = request.form['otp']
        totp = pyotp.TOTP(user['secret'])
        if totp.verify(otp):
            return "Login berhasil!"
        else:
            return "OTP salah!"

    # buat QR code untuk pertama kali agar bisa dipindai di Google Authenticator
    totp_uri = pyotp.totp.TOTP(user['secret']).provisioning_uri(name=username, issuer_name="MyApp")
    qr = qrcode.make(totp_uri)
    buffered = io.BytesIO()
    qr.save(buffered, format="PNG")
    qr_b64 = base64.b64encode(buffered.getvalue()).decode()
    
    return render_template_string(otp_page + f'<br><img src="data:image/png;base64,{qr_b64}">')

if __name__ == "__main__":
    app.run(debug=True)
